  name: Docker Publish (GHCR)

  on:
    push:
      branches: [ "**" ]

  permissions:
    contents: read
    packages: write

  env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

  jobs:
    build-and-push:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - name: Set up JDK 21
          uses: actions/setup-java@v4
          with:
            distribution: temurin
            java-version: "21"
            cache: maven
            
        - name: Grant execute permission for Maven wrapper
          # On cible le fichier mvnw à l'intérieur du sous-dossier
          run: chmod +x ./mvnw
        - name: Build & Test
          run: ./mvnw clean test

        - name: Log in to GHCR
          uses: docker/login-action@v3
          with:
            registry: ${{ env.REGISTRY }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build & Push
          uses: docker/build-push-action@v6
          with:
            context: .
            push: true
            tags: |
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}